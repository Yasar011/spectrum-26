<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPECTRUM '26 | NIFT Jodhpur</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Manrope:wght@200;400;600;700&family=Oswald:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyATPWBVx5bqqIrbgaXm44KDAy29b4ru6NY",
            authDomain: "spectram-234f7.firebaseapp.com",
            projectId: "spectram-234f7",
            storageBucket: "spectram-234f7.firebasestorage.app",
            messagingSenderId: "192476382126",
            appId: "1:192476382126:web:26422db3e948165933be3f",
            databaseURL: "https://spectram-234f7-default-rtdb.firebaseio.com"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // --- 2. PAYMENT & IMAGE SETTINGS ---
        // Get this from https://api.imgbb.com/ (It's free)
        const IMGBB_KEY = "YOUR_IMGBB_API_KEY_HERE"; 
        
        // Fallback admin URL
        const ADMIN_URL = "admin.html"; 
    </script>

    <style>
        :root { --accent: #db2777; --terminal-green: #00ff41; }
        html { scroll-behavior: smooth; }
        body { background-color: #050505; color: #f3f3f3; font-family: 'Manrope', sans-serif; overflow-x: hidden; }
        
        .font-display { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.1em; }
        .font-serif { font-family: 'Italiana', serif; }
        .font-mono { font-family: 'Space Mono', monospace; }

        /* FX */
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.4; pointer-events: none; }
        .scanline { position: fixed; left: 0; top: 0; width: 100%; height: 100px; background: linear-gradient(to bottom, transparent, rgba(0, 255, 65, 0.05), transparent); animation: scanline 6s linear infinite; pointer-events: none; z-index: 999; }
        @keyframes scanline { 0% { transform: translateY(-100vh); } 100% { transform: translateY(100vh); } }
        .glitch-text { position: relative; }
        .glitch-text::before, .glitch-text::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000000; opacity: 0; }
        .glitch-text.glitching::before { opacity: 1; left: 2px; text-shadow: -1px 0 #ff00c1; clip-path: inset(44% 0 61% 0); }
        .glitch-text.glitching::after { opacity: 1; left: -2px; text-shadow: -1px 0 #00fff9; clip-path: inset(54% 0 21% 0); }
        .reveal { opacity: 0; transform: translateY(30px); transition: all 0.8s ease; }
        .reveal.active { opacity: 1; transform: translateY(0); }

        /* UI */
        .glass-panel { background: rgba(20, 20, 20, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .btn-outline { background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); transition: 0.3s; }
        .btn-outline:hover { border-color: var(--accent); background: rgba(219, 39, 119, 0.1); color: white; box-shadow: 0 0 15px var(--accent); }
        .auth-tab { padding-bottom: 10px; color: #666; border-bottom: 2px solid transparent; transition: 0.3s; cursor: pointer; }
        .auth-tab.active { color: white; border-bottom: 2px solid var(--accent); }
        .view-section { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease, transform 0.6s ease; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }
        #sidebar { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* CART & TOAST */
        .selected-pass { border-color: var(--accent) !important; background: rgba(219, 39, 119, 0.15) !important; transform: translateY(-5px); box-shadow: 0 10px 30px -10px rgba(219, 39, 119, 0.3); }
        #cart-bar { transition: transform 0.3s ease; }
        #notification-toast { transform: translateX(120%); transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        #notification-toast.show { transform: translateX(0); }
        
        /* INFO EXPAND */
        .info-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #111; }
        .info-content.open { max-height: 300px; padding: 10px; border-top: 1px solid #333; overflow-y: auto; }

        /* SCHEDULE STYLES */
        .timeline-line { position: absolute; left: 19px; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.1); z-index: 0; }
        .timeline-item:last-child .timeline-line { display: none; }
        .timeline-dot { width: 12px; height: 12px; background: #000; border: 2px solid var(--accent); border-radius: 50%; z-index: 10; position: relative; }
        
        /* HOLOGRAPHIC ID */
        .holo-card { background: linear-gradient(135deg, #111 0%, #1a1a1a 100%); border: 1px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden; }
        .holo-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent); transform: rotate(45deg); animation: holo 3s infinite; pointer-events: none; }
        @keyframes holo { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }
    </style>
</head>
<body>

    <!-- 3D BACKGROUND -->
    <canvas id="bg-canvas"></canvas>
    <div class="scanline"></div>
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 800; opacity: 0.05; background-image: url('https://grainy-gradients.vercel.app/noise.svg'); filter: contrast(150%) brightness(100%);"></div>

    <!-- PUSH NOTIFICATION TOAST -->
    <div id="notification-toast" class="fixed top-24 right-6 z-[100] max-w-xs w-full bg-zinc-900 border-l-4 border-pink-500 p-4 shadow-2xl flex items-start gap-4">
        <i data-lucide="bell" class="text-pink-500 w-5 h-5 mt-1"></i>
        <div><h4 class="text-white font-bold uppercase text-xs tracking-widest mb-1">Incoming Transmission</h4><p id="toast-message" class="text-gray-400 text-xs font-mono leading-tight">System Update...</p></div>
    </div>

    <!-- INTRO -->
    <div id="intro-screen" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center text-center font-mono">
        <div class="relative z-10 w-full max-w-2xl px-6">
            <div id="terminal-output" class="text-left text-xs md:text-sm text-green-500 mb-8 h-32 border-l-2 border-green-500 pl-4 font-bold overflow-hidden"></div>
            <div id="intro-title" class="opacity-0 transition-opacity duration-1000"><h1 class="text-6xl md:text-9xl font-display font-bold text-white tracking-widest glitch-text" data-text="SPECTRUM">SPEC<span class="text-pink-600">TRUM</span></h1><p class="text-xs font-bold tracking-[0.8em] text-gray-500 uppercase mt-4 animate-pulse">'26 SYSTEM ONLINE</p></div>
            <button id="enter-btn" onclick="enterSite()" class="mt-12 opacity-0 btn-outline text-green-500 border-green-500 hover:bg-green-500 hover:text-black hover:border-green-500 uppercase tracking-widest text-xs py-4 px-8">[ Enter System ]</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-content" class="hidden opacity-0">
        
        <!-- NAV -->
        <nav class="fixed top-0 left-0 w-full z-50 px-6 py-6 flex justify-between items-center text-white backdrop-blur-sm bg-black/30 border-b border-white/5">
            <button onclick="toggleSidebar()" class="flex items-center gap-3"><div class="flex flex-col gap-1.5"><span class="w-6 h-0.5 bg-white"></span><span class="w-4 h-0.5 bg-white"></span></div><span class="text-[10px] font-bold uppercase tracking-widest hidden md:block">Menu</span></button>
            <div class="absolute left-1/2 transform -translate-x-1/2 font-display text-xl font-bold tracking-widest cursor-pointer" onclick="switchView('home')">SPECTRUM '26</div>
            <div class="flex gap-4">
                <button onclick="handleAccountClick()" class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest hover:text-pink-500 transition-colors"><i data-lucide="user" class="w-4 h-4"></i><span id="nav-user-text" class="hidden md:block">Login</span></button>
            </div>
        </nav>

        <!-- SIDEBAR -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[55] hidden transition-opacity duration-300 opacity-0"></div>
        <div id="sidebar" class="fixed inset-y-0 left-0 w-full md:w-[400px] bg-black/90 border-r border-zinc-800 z-[60] transform -translate-x-full flex flex-col p-10 justify-between backdrop-blur-xl">
            <div class="flex justify-between items-center"><span class="text-xs text-gray-500 uppercase tracking-widest">Navigation</span><button onclick="toggleSidebar()"><i data-lucide="x" class="text-white hover:text-pink-500"></i></button></div>
            <div class="flex flex-col gap-6 font-display text-3xl">
                <a onclick="switchView('home'); toggleSidebar()" class="text-white hover:text-pink-600 hover:pl-4 transition-all cursor-pointer">Home</a>
                <a onclick="switchView('schedule'); toggleSidebar()" class="text-pink-500 hover:text-white hover:pl-4 transition-all cursor-pointer">Schedule</a>
                <a onclick="switchView('tickets'); toggleSidebar()" class="text-white hover:text-pink-600 hover:pl-4 transition-all cursor-pointer">Buy Tickets</a>
                <a onclick="switchView('merch'); toggleSidebar()" class="text-white hover:text-pink-600 hover:pl-4 transition-all cursor-pointer">Merch Store <span class="text-xs align-top bg-pink-600 text-white px-1 ml-2">NEW</span></a>
                <a href="#" onclick="toggleSidebar()" class="text-white hover:text-pink-600 hover:pl-4 transition-all">Sponsors</a>
            </div>
        </div>

        <!-- HOME VIEW -->
        <main id="view-home" class="view-section active">
            <section class="relative h-screen flex flex-col items-center justify-center overflow-hidden">
                <div class="relative z-10 text-center px-4 max-w-4xl reveal active">
                    <div class="mb-6 inline-block border border-pink-500/50 bg-pink-500/10 backdrop-blur-md px-4 py-2 rounded-full"><p class="text-[10px] font-bold uppercase tracking-widest text-pink-200">Feb 24 - 25 • 2026</p></div>
                    <h1 class="text-7xl md:text-[9rem] font-display font-bold text-white leading-none mb-4 drop-shadow-[0_0_15px_rgba(219,39,119,0.5)]">SPEC<span class="text-pink-600">TRUM</span></h1>
                    <div class="flex justify-center gap-6 mb-12 font-mono text-gray-400 text-xs md:text-sm">
                        <div class="text-center"><span class="block text-2xl md:text-4xl text-white font-bold" id="cd-days">00</span>DAYS</div>
                        <div class="text-center"><span class="block text-2xl md:text-4xl text-white font-bold" id="cd-hours">00</span>HRS</div>
                        <div class="text-center"><span class="block text-2xl md:text-4xl text-white font-bold" id="cd-mins">00</span>MINS</div>
                    </div>
                    <div class="flex justify-center"><button onclick="switchView('tickets')" class="bg-white text-black px-12 py-4 font-bold uppercase tracking-widest text-sm hover:bg-pink-600 hover:text-white transition-all transform hover:scale-105 shadow-[0_0_20px_rgba(255,255,255,0.3)]">Get Passes</button></div>
                </div>
            </section>
        </main>

        <!-- SCHEDULE VIEW -->
        <section id="view-schedule" class="view-section min-h-screen pt-32 px-6 pb-24 bg-zinc-950/95 backdrop-blur-lg">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-4xl font-display text-white mb-8">Event Schedule</h2>
                <div class="flex gap-4 mb-12">
                    <button onclick="renderSchedule('day1')" id="tab-day1" class="text-xl font-bold uppercase px-6 py-2 border-b-2 border-pink-500 text-white">Day 1</button>
                    <button onclick="renderSchedule('day2')" id="tab-day2" class="text-xl font-bold uppercase px-6 py-2 border-b-2 border-transparent text-gray-500">Day 2</button>
                </div>
                <div id="schedule-container" class="relative pl-6 space-y-8"></div>
            </div>
        </section>

        <!-- TICKETS & EVENTS STORE -->
        <section id="view-tickets" class="view-section min-h-screen pt-32 px-6 pb-24 bg-zinc-950/95 backdrop-blur-lg">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-end mb-12 border-b border-zinc-800 pb-6 reveal active">
                    <div><span class="text-pink-600 text-xs font-bold uppercase tracking-widest mb-2 block">Store</span><h2 class="text-4xl md:text-6xl font-display text-white">Select Pass</h2></div>
                    <button onclick="switchView('home')" class="btn-outline py-2 px-6 text-xs uppercase font-bold">Back to Home</button>
                </div>
                
                <!-- PASSES -->
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-20" id="pass-selection-container">
                    <div id="pass-gen" class="glass-panel p-6 cursor-pointer hover:bg-white/5 transition-all" onclick="selectPass('Cyber Entry', 299, 'base', 'pass-gen')"><h3 class="text-xl font-bold uppercase text-white">Cyber Entry</h3><p class="text-[10px] text-gray-400 mt-2 h-10">Entry Only. Add Events Below.</p><div class="border-t border-white/10 pt-4 flex justify-between items-center mt-4"><span class="text-lg font-bold text-white">₹299</span><div class="w-4 h-4 rounded-full border border-white" id="radio-pass-gen"></div></div></div>
                    <div id="pass-std" class="bg-zinc-900 border border-pink-900 p-6 transform md:-translate-y-4 shadow-xl cursor-pointer" onclick="selectPass('Nexus Prime', 499, 'base', 'pass-std')"><span class="text-[10px] font-bold text-pink-500 uppercase tracking-widest">Recommended</span><h3 class="text-xl font-bold uppercase text-white mt-1">Nexus Prime</h3><p class="text-[10px] text-gray-400 mt-2 h-10">Entry + <b>2 Regular Events FREE</b>.</p><div class="border-t border-white/10 pt-4 flex justify-between items-center mt-4"><span class="text-lg font-bold text-white">₹499</span><div class="w-4 h-4 rounded-full border border-pink-500" id="radio-pass-std"></div></div></div>
                </div>

                <!-- MESSAGES -->
                <div id="nift-message" class="hidden text-center mb-10 p-6 bg-green-900/30 border border-green-500 rounded"><h3 class="text-xl font-bold text-green-400">NIFT STUDENT ACCESS</h3><p class="text-gray-300 text-sm">Nexus Prime Pass Active (Free). Select your events.</p></div>
                <div id="existing-user-message" class="hidden text-center mb-10 p-6 bg-blue-900/30 border border-blue-500 rounded"><h3 class="text-xl font-bold text-blue-400">PASS ACTIVE</h3><p class="text-gray-300 text-sm">You already have a pass. You can add more events below.</p></div>

                <!-- EVENT LIST -->
                <div id="event-selection-area" class="transition-opacity duration-300">
                    <h3 class="text-2xl font-display text-white mb-8 border-b border-zinc-800 pb-4">Add Events</h3>
                    <div class="flex flex-wrap gap-3 mb-8">
                        <button onclick="filterEvents('all')" class="filter-btn text-[10px] font-bold uppercase tracking-widest px-4 py-3 border border-white bg-white text-black">All</button>
                        <button onclick="filterEvents('tech')" class="filter-btn text-[10px] font-bold uppercase tracking-widest px-4 py-3 border border-zinc-700 text-white">Tech</button>
                        <button onclick="filterEvents('culture')" class="filter-btn text-[10px] font-bold uppercase tracking-widest px-4 py-3 border border-zinc-700 text-white">Cultural</button>
                        <button onclick="filterEvents('sports')" class="filter-btn text-[10px] font-bold uppercase tracking-widest px-4 py-3 border border-zinc-700 text-white">Sports</button>
                    </div>
                    <div id="events-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </div>
            </div>
        </section>

        <!-- MERCH STORE -->
        <section id="view-merch" class="view-section min-h-screen pt-32 px-6 pb-24 bg-zinc-950/95 backdrop-blur-lg">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-end mb-12 border-b border-zinc-800 pb-6 reveal active">
                    <div><span class="text-pink-600 text-xs font-bold uppercase tracking-widest mb-2 block">Apparel</span><h2 class="text-4xl md:text-6xl font-display text-white">Official Merch</h2></div>
                    <button onclick="switchView('home')" class="btn-outline py-2 px-6 text-xs uppercase font-bold">Back</button>
                </div>
                
                <div id="merch-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12"></div>

                <!-- Merch Checkout Form -->
                <div id="merch-form" class="hidden bg-zinc-900 border border-zinc-800 p-6 max-w-2xl mx-auto shadow-2xl">
                    <h3 class="text-xl font-bold text-pink-500 uppercase mb-4">Delivery Details</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="merch-size" class="bg-black border border-zinc-700 p-3 text-white text-xs uppercase"><option value="S">Small</option><option value="M">Medium</option><option value="L">Large</option><option value="XL">Extra Large</option></select>
                            <input id="merch-qty" type="number" min="1" value="1" class="bg-black border border-zinc-700 p-3 text-white text-xs">
                        </div>
                        <textarea id="merch-address" placeholder="Full Delivery Address (Hostel/Flat, Street, City, Pin)" class="w-full bg-black border border-zinc-700 p-3 text-white text-xs uppercase h-24"></textarea>
                        <div class="flex justify-between items-center pt-4 border-t border-zinc-800">
                            <div><p class="text-[10px] text-gray-500 uppercase">Item</p><p id="merch-selected-name" class="text-white font-bold">--</p></div>
                            <button onclick="initiateMerchPayment()" class="bg-white text-black px-6 py-3 font-bold uppercase text-xs hover:bg-pink-500 hover:text-white">Pay & Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CART BAR -->
        <div id="cart-bar" class="fixed bottom-0 left-0 w-full bg-zinc-900/90 backdrop-blur border-t border-zinc-800 p-4 z-[90] transform translate-y-full flex justify-between items-center">
            <div><p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Total Selection</p><div class="flex items-baseline gap-2"><span id="cart-total" class="text-xl font-mono font-bold text-white">₹0</span><span id="cart-desc" class="text-xs text-pink-500 ml-2"></span></div></div>
            <button onclick="checkUpsell()" class="bg-white text-black px-8 py-4 text-xs font-bold uppercase tracking-widest hover:bg-pink-600 hover:text-white transition-colors">Checkout</button>
        </div>

        <!-- AUTH & PAYMENT MODAL -->
        <div id="auth-modal" class="fixed inset-0 z-[200] hidden items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="closeModal()"></div>
            <div class="relative z-10 w-full max-w-md bg-zinc-950 border border-zinc-800 p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white p-2"><i data-lucide="x"></i></button>
                
                <!-- PROFILE VIEW -->
                <div id="view-profile" class="hidden text-center space-y-4">
                    <h2 class="text-xl font-display text-white">My Pass</h2>
                    <div id="ticket-container" class="bg-white text-black p-6 rounded-sm relative overflow-hidden">
                        <div id="ticket-loading" class="text-xs font-mono">Loading...</div>
                        <div id="ticket-verified" class="hidden"><img id="ticket-qr" src="" class="w-40 h-40 mx-auto mb-2 mix-blend-multiply"><p class="text-xs font-mono font-bold" id="ticket-id">ID: ----</p><p class="text-[10px] uppercase text-green-600 font-bold mt-2">● Authorized</p><p class="text-[10px] font-bold text-gray-500" id="ticket-info-plan"></p></div>
                        <div id="ticket-pending" class="hidden py-8"><i data-lucide="clock" class="w-12 h-12 mx-auto text-yellow-600 mb-4"></i><h3 class="font-bold uppercase">Processing</h3><p class="text-xs text-gray-600 mt-2 px-4">Verification Pending.</p></div>
                        <div id="ticket-none" class="hidden py-8"><p class="text-xs text-gray-600 mb-4">No active pass.</p><button onclick="closeModal(); switchView('tickets')" class="bg-black text-white px-6 py-2 text-xs font-bold uppercase">Buy Now</button></div>
                    </div>
                    <div class="flex justify-between items-center px-2"><div class="text-left"><p id="profile-name" class="text-sm font-bold text-white"></p><p id="profile-email" class="text-[10px] text-gray-500"></p></div><button onclick="logout()" class="text-red-500 text-xs font-bold uppercase hover:text-white p-2">Logout</button></div>
                </div>

                <!-- AUTH VIEW -->
                <div id="view-auth">
                    <div id="auth-tabs" class="flex gap-6 mb-8 border-b border-zinc-800"><div onclick="switchAuthMode('login')" id="tab-login" class="auth-tab active text-xs font-bold uppercase tracking-widest pb-3">Log In</div><div onclick="switchAuthMode('register')" id="tab-register" class="auth-tab text-xs font-bold uppercase tracking-widest pb-3">Register</div></div>
                    <div id="form-login" class="space-y-4"><input id="login-email" type="email" placeholder="Email" class="w-full bg-black border border-zinc-800 p-3 text-xs text-white uppercase outline-none"><input id="login-pass" type="password" placeholder="Password" class="w-full bg-black border border-zinc-800 p-3 text-xs text-white uppercase outline-none"><button onclick="userLogin()" class="w-full bg-white text-black font-bold uppercase py-3 text-xs hover:bg-gray-200">Access</button></div>
                    <div id="form-register" class="space-y-4 hidden"><input id="reg-name" type="text" placeholder="Full Name" class="w-full bg-black border border-zinc-800 p-3 text-xs text-white uppercase outline-none"><input id="reg-email" type="email" placeholder="Email" class="w-full bg-black border border-zinc-800 p-3 text-xs text-white uppercase outline-none"><input id="reg-pass" type="password" placeholder="Password" class="w-full bg-black border border-zinc-800 p-3 text-xs text-white uppercase outline-none"><input id="reg-phone" type="tel" placeholder="Phone" class="w-full bg-black border border-zinc-800 p-3 text-xs text-white uppercase outline-none"><button onclick="userRegister()" class="w-full bg-white text-black font-bold uppercase py-3 text-xs hover:bg-gray-200">Register</button></div>
                </div>

                <!-- RECEIPT VIEW -->
                <div id="view-receipt" class="hidden space-y-4">
                    <h2 class="text-xl font-display text-white text-center">Summary</h2>
                    <div class="bg-zinc-900 p-4 rounded text-xs space-y-2 font-mono">
                        <div class="flex justify-between text-white"><span id="rec-pass-name">Pass</span><span id="rec-pass-price">₹0</span></div>
                        <div id="rec-events-list" class="space-y-1 text-gray-400 border-t border-zinc-800 pt-2 mt-2"></div>
                        <div class="flex justify-between text-pink-500 font-bold border-t border-zinc-800 pt-2 mt-2"><span>TOTAL</span><span id="rec-total">₹0</span></div>
                    </div>
                    <button id="btn-proceed" onclick="showPayment()" class="w-full bg-white text-black font-bold uppercase py-3 text-xs hover:bg-gray-200">Proceed to Pay</button>
                </div>

                <!-- PAYMENT VIEW (NEW) -->
                <div id="view-payment" class="hidden text-center space-y-4">
                    <h2 class="text-xl font-display text-white">Payment</h2>
                    <p class="text-[10px] text-gray-500 uppercase">Pay: <span id="pay-amount-display" class="text-white font-bold text-lg"></span></p>
                    
                    <!-- QR Area -->
                    <div class="relative group">
                        <div class="bg-white p-2 w-fit mx-auto rounded"><img id="payment-qr-image" src="" class="w-48 h-48 mix-blend-multiply"></div>
                        <button onclick="reportBrokenQR()" class="mt-2 text-[10px] text-red-500 underline hover:text-red-400">QR not working? Click to switch.</button>
                    </div>

                    <!-- Screenshot Upload (ImgBB) -->
                    <div class="text-left border-t border-zinc-800 pt-4 mt-4">
                        <label class="text-[10px] text-pink-500 font-bold uppercase mb-2 block">1. Upload Screenshot (Free)</label>
                        <input type="file" id="payment-screenshot" accept="image/*" class="w-full text-xs text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-zinc-800 file:text-white hover:file:bg-pink-600 mb-2">
                        <p id="upload-status" class="text-[10px] text-gray-500">Waiting for file...</p>
                    </div>

                    <!-- UTR -->
                    <div class="text-left mt-2">
                        <label class="text-[10px] text-gray-500 font-bold uppercase mb-2 block">2. UTR (Backup)</label>
                        <input id="input-utr" type="text" placeholder="12-Digit UTR" class="w-full bg-black border border-zinc-800 p-3 text-xs text-white uppercase outline-none tracking-widest">
                    </div>

                    <button id="btn-verify-pay" onclick="uploadAndCompleteOrder()" class="w-full bg-green-600 text-white font-bold uppercase py-3 text-xs mt-4">Submit Verification</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 3. ANIMATION & INTRO ---
        const canvas = document.getElementById('bg-canvas');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const geometry = new THREE.IcosahedronGeometry(10, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0xdb2777, wireframe: true, transparent: true, opacity: 0.3 });
        const sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);
        camera.position.z = 20;
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (event) => { mouseX = event.clientX / window.innerWidth - 0.5; mouseY = event.clientY / window.innerHeight - 0.5; });
        function animate() { requestAnimationFrame(animate); sphere.rotation.x += 0.001; sphere.rotation.y += 0.002; sphere.rotation.y += mouseX * 0.05; sphere.rotation.x += mouseY * 0.05; renderer.render(scene, camera); }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        window.onload = function() { 
            animate(); 
            startCountdown();
            if(sessionStorage.getItem('introDone')) { document.getElementById('intro-screen').style.display='none'; document.getElementById('main-content').classList.remove('hidden'); document.getElementById('main-content').style.opacity='1'; document.getElementById('view-home').classList.add('active'); document.querySelectorAll('.reveal').forEach(el=>el.classList.add('active')); } 
            else { runTerminalIntro(); }
            fetchDynamicContent(); // Load Data
        };

        // --- 4. GLOBAL VARS ---
        let currentUser=null, userDataDB=null, finalTotal=0, promoApplied=null, isNift=false, hasExistingPass=false;
        let cart = { pass: null, events: [] }; 
        let currentQRIndex = 0;
        let availableQRs = [];
        let selectedMerchItem = null;
        let globalEventsData = [];

        // --- 5. DATA FETCHING ---
        function fetchDynamicContent() {
            // Events
            db.ref('events').on('value', snapshot => {
                const data = snapshot.val();
                if(data) {
                    globalEventsData = Array.isArray(data) ? data : Object.values(data);
                    filterEvents('all');
                }
            });
            // Schedule
            db.ref('schedule').on('value', snapshot => {
                const data = snapshot.val();
                if(data) { window.schedule = data; renderSchedule('day1'); }
            });
            // Merch
            db.ref('merch').on('value', snapshot => {
                const data = snapshot.val();
                renderMerch(data);
            });
            // QRs
            db.ref('payment_qrs').on('value', snapshot => {
                const data = snapshot.val();
                if(data) {
                    availableQRs = Object.entries(data).map(([key, val]) => ({ id: key, ...val }));
                }
            });
        }

        // --- 6. DATABASE SEEDER (RUN ONCE) ---
        function seedDatabase() {
            const seedData = {
                events: [
                    { id: 1, club: 'tech', title: 'Hackathon', price: 150, img: 'https://images.unsplash.com/photo-1504384308090-c54be3855833?w=600', members: '4', desc: '24hr coding battle.', rules: '#' },
                    { id: 2, club: 'tech', title: 'RoboWar', price: 200, img: 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=600', members: '2-4', desc: 'Bot destruction.', rules: '#' },
                    { id: 3, club: 'culture', title: 'Street Dance', price: 50, img: 'https://images.unsplash.com/photo-1535525153412-5a42439a210d?w=600', members: 'Group', desc: 'Hip-hop battle.', rules: '#' },
                    { id: 4, club: 'culture', title: 'Fashion Show', price: 200, img: 'https://images.unsplash.com/photo-1504196606672-aef5c9cefcce?w=600', members: '8-12', desc: 'Ramp walk.', rules: '#' },
                    { id: 5, club: 'sports', title: 'Valorant', price: 100, img: 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=600', members: '5', desc: '5v5 FPS.', rules: '#' },
                    { id: 6, club: 'sports', title: 'Futsal', price: 300, img: 'https://images.unsplash.com/photo-1518091043644-c1d4457512c6?w=600', members: '6', desc: '5-a-side Football.', rules: '#' }
                ],
                schedule: {
                    day1: [{ time: "09:00 AM", title: "Opening Ceremony", loc: "Audi" }, { time: "02:00 PM", title: "Hackathon Starts", loc: "IT Lab" }],
                    day2: [{ time: "10:00 AM", title: "RoboWar", loc: "Ground" }, { time: "06:00 PM", title: "Fashion Show", loc: "Ramp" }]
                },
                merch: {
                    m1: { name: "Cyber Cap", price: 299, img: "https://images.unsplash.com/photo-1588850561407-ed78c282e89b?w=600" },
                    m2: { name: "Glitch Tee (Oversized)", price: 599, img: "https://images.unsplash.com/photo-1576566588028-4147f3842f27?w=600" },
                    m3: { name: "Neon Tee (Fitted)", price: 499, img: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=600" }
                },
                payment_qrs: {
                    qr1: { url: "upi://pay?pa=chyasar2004-2@oksbi", reports: 0 },
                    qr2: { url: "upi://pay?pa=admin2@oksbi", reports: 0 },
                    qr3: { url: "upi://pay?pa=admin3@oksbi", reports: 0 },
                    qr4: { url: "upi://pay?pa=admin4@oksbi", reports: 0 },
                    qr5: { url: "upi://pay?pa=admin5@oksbi", reports: 0 }
                }
            };
            db.ref('/').update(seedData, (error) => {
                if(error) console.error(error);
                else alert("Database Seeded Successfully! Refresh page.");
            });
        }

        // --- 7. AUTH & LOGIC ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                const cleanEmail = user.email.replace(/\./g, ',');
                db.ref('users/' + cleanEmail).on('value', (snapshot) => {
                    userDataDB = snapshot.val();
                    updateNav(userDataDB ? userDataDB.name : "User");
                    if(user.email.toLowerCase().endsWith('@nift.ac.in')) isNift = true;
                    if (userDataDB && (userDataDB.paymentStatus === 'Verified' || userDataDB.paymentStatus === 'Pending')) hasExistingPass = true;
                });
            } else { currentUser = null; userDataDB = null; updateNav("Login"); isNift=false; hasExistingPass=false; }
        });

        function selectPass(name, price, type, elId) {
            ['pass-gen', 'pass-std'].forEach(id => { document.getElementById(id).classList.remove('selected-pass'); document.getElementById(id).classList.add('glass-panel'); });
            document.getElementById(elId).classList.remove('glass-panel'); document.getElementById(elId).classList.add('selected-pass');
            cart.pass = { name, price, type };
            updateCartUI();
        }

        function filterEvents(cat) {
            const grid = document.getElementById('events-grid');
            grid.innerHTML='';
            const filtered = cat==='all' ? globalEventsData : globalEventsData.filter(e => e.club === cat);
            filtered.forEach(e => {
                let btnHtml = `<button onclick="toggleEvent(${e.id}, '${e.title}', ${e.price})" class="w-full mt-4 border border-zinc-700 text-white py-3 text-xs font-bold uppercase hover:bg-zinc-800">Add</button>`;
                if(cart.events.some(ev => ev.id == e.id)) btnHtml = `<button class="w-full mt-4 bg-pink-600 text-white py-3 text-xs font-bold uppercase">Selected</button>`;
                grid.innerHTML += `<div class="bg-zinc-900/80 backdrop-blur border border-zinc-800"><div class="h-48 overflow-hidden"><img src="${e.img}" class="w-full h-full object-cover"></div><div class="p-4"><h3 class="text-white font-bold uppercase text-sm">${e.title}</h3><p class="text-[10px] text-gray-500">Fee: ${isNift ? 'FREE' : '₹'+e.price}</p>${btnHtml}</div></div>`;
            });
        }

        function toggleEvent(id, title, price) {
            const index = cart.events.findIndex(e => e.id === id);
            if (index > -1) cart.events.splice(index, 1);
            else cart.events.push({ id, title, price });
            updateCartUI();
            filterEvents('all'); // Refresh buttons
        }

        function updateCartUI() {
            const bar = document.getElementById('cart-bar');
            if (cart.pass || cart.events.length > 0) {
                bar.classList.remove('translate-y-full');
                let total = cart.pass ? cart.pass.price : 0;
                cart.events.forEach(e => total += isNift ? 0 : e.price);
                document.getElementById('cart-total').innerText = "₹" + total;
                document.getElementById('cart-desc').innerText = (cart.pass ? cart.pass.name : "") + (cart.events.length ? ` + ${cart.events.length} Events` : "");
            } else bar.classList.add('translate-y-full');
        }

        function checkUpsell() {
            if (!currentUser) { handleAccountClick(); return; }
            if (!cart.pass && !hasExistingPass) return alert("Please select a Pass first!");
            
            // Calc total
            let total = 0;
            if(!hasExistingPass) total += isNift ? 0 : cart.pass.price;
            cart.events.forEach(e => total += isNift ? 0 : e.price);
            
            finalTotal = total;
            document.getElementById('rec-total').innerText = "₹" + total;
            document.getElementById('rec-events-list').innerHTML = cart.events.map(e => `<div class="flex justify-between"><span>${e.title}</span><span>${isNift ? 'FREE' : '₹'+e.price}</span></div>`).join('');
            
            openModal();
            document.getElementById('view-auth').classList.add('hidden');
            document.getElementById('view-profile').classList.add('hidden');
            document.getElementById('view-receipt').classList.remove('hidden');
            document.getElementById('view-payment').classList.add('hidden');
        }

        // --- 8. MERCH LOGIC ---
        function renderMerch(merchData) {
            const grid = document.getElementById('merch-grid');
            grid.innerHTML = '';
            if(!merchData) return;
            Object.entries(merchData).forEach(([key, item]) => {
                grid.innerHTML += `<div class="bg-zinc-900 border border-zinc-800 hover:border-pink-500 transition-all group"><div class="h-64 overflow-hidden"><img src="${item.img}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"></div><div class="p-6 text-center"><h3 class="text-xl font-display text-white mb-2">${item.name}</h3><p class="text-pink-500 font-bold mb-4">₹${item.price}</p><button onclick="selectMerchItem('${key}', '${item.name}', ${item.price})" class="btn-outline w-full py-2 text-xs font-bold uppercase">Buy Now</button></div></div>`;
            });
        }
        function selectMerchItem(id, name, price) {
            if(!currentUser) return handleAccountClick();
            selectedMerchItem = { id, name, price };
            document.getElementById('merch-form').classList.remove('hidden');
            document.getElementById('merch-selected-name').innerText = `${name} (₹${price})`;
            document.getElementById('merch-form').scrollIntoView({behavior: "smooth"});
        }
        function initiateMerchPayment() {
            const qty = document.getElementById('merch-qty').value;
            const total = selectedMerchItem.price * qty;
            showPayment(total);
        }

        // --- 9. SMART PAYMENT & QR SYSTEM ---
        function assignQR() {
            if(availableQRs.length === 0) return null;
            if(!sessionStorage.getItem('assignedQRIndex')) {
                // Stable index based on UID
                const sum = currentUser.uid.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                currentQRIndex = sum % availableQRs.length;
                sessionStorage.setItem('assignedQRIndex', currentQRIndex);
            } else currentQRIndex = parseInt(sessionStorage.getItem('assignedQRIndex'));
            return availableQRs[currentQRIndex];
        }

        function showPayment(amount = null) {
            const payAmount = amount || finalTotal;
            if (payAmount === 0 && !selectedMerchItem) return completePayment(true); // Free NIFT
            
            const qrObj = assignQR();
            if(!qrObj) return alert("Error: No QRs available. Run seedDatabase()");

            // Hide Receipt, Show Payment
            document.getElementById('view-receipt').classList.add('hidden');
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-modal').style.display='flex';
            document.getElementById('view-payment').classList.remove('hidden');
            
            // Generate QR
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrObj.url + "&am=" + payAmount + "&cu=INR")}`;
            document.getElementById('payment-qr-image').src = qrUrl;
            document.getElementById('pay-amount-display').innerText = "₹" + payAmount;
        }

        function reportBrokenQR() {
            if(confirm("Report current QR as broken? We will switch you to a new one.")) {
                const currentQR = availableQRs[currentQRIndex];
                db.ref('payment_qrs/' + currentQR.id + '/reports').transaction(val => (val || 0) + 1);
                currentQRIndex = (currentQRIndex + 1) % availableQRs.length;
                sessionStorage.setItem('assignedQRIndex', currentQRIndex);
                showPayment(selectedMerchItem ? (selectedMerchItem.price * document.getElementById('merch-qty').value) : finalTotal);
            }
        }

        // --- 10. IMGBB UPLOAD & ORDER ---
        function uploadAndCompleteOrder() {
            const fileInput = document.getElementById('payment-screenshot');
            const file = fileInput.files[0];
            const utr = document.getElementById('input-utr').value;

            if(!file) return alert("Please upload a screenshot.");
            if(!IMGBB_KEY || IMGBB_KEY === "YOUR_IMGBB_API_KEY_HERE") return alert("Dev Error: Set IMGBB_KEY in code.");

            // UI Feedback
            const btn = document.getElementById('btn-verify-pay');
            btn.innerText = "Uploading Proof (0%)...";
            btn.disabled = true;

            // ImgBB Upload
            const formData = new FormData();
            formData.append("image", file);
            
            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData })
            .then(res => res.json())
            .then(result => {
                if(result.success) {
                    btn.innerText = "Verifying...";
                    submitOrderToDB(result.data.url, utr);
                } else {
                    alert("Upload Failed: " + result.error.message);
                    btn.innerText = "Submit Verification";
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Upload Error.");
                btn.disabled = false;
            });
        }

        function submitOrderToDB(proofUrl, utr) {
            const cleanEmail = currentUser.email.replace(/\./g, ',');
            const timestamp = new Date().toISOString();
            
            if(selectedMerchItem) {
                // Merch Order
                const orderData = {
                    item: selectedMerchItem.name,
                    price: selectedMerchItem.price,
                    qty: document.getElementById('merch-qty').value,
                    size: document.getElementById('merch-size').value,
                    address: document.getElementById('merch-address').value,
                    proof: proofUrl,
                    utr: utr,
                    status: "Pending",
                    timestamp: timestamp
                };
                db.ref('users/' + cleanEmail + '/merch_orders').push(orderData).then(() => {
                    alert("Merch Order Placed! Screenshot uploaded.");
                    window.location.reload();
                });
            } else {
                // Ticket Order
                db.ref('users/' + cleanEmail).update({
                    paymentStatus: "Pending",
                    utr: utr,
                    order: {
                        pass: cart.pass.name,
                        events: cart.events,
                        total: finalTotal,
                        proof: proofUrl,
                        timestamp: timestamp
                    }
                }).then(() => {
                    alert("Pass Request Submitted! Screenshot uploaded.");
                    window.location.reload();
                });
            }
        }

        // --- HELPERS ---
        function renderSchedule(day) { const c = document.getElementById('schedule-container'); if(!window.schedule) return; let html=''; window.schedule[day].forEach(i=>{ html+=`<div class="timeline-item relative pl-8 pb-8"><div class="timeline-line"></div><div class="timeline-dot absolute left-3 top-1"></div><div class="flex gap-4"><span class="text-pink-500 font-mono font-bold w-20">${i.time}</span><div class="bg-zinc-900 border border-zinc-800 p-4 w-full"><h4 class="text-white font-bold uppercase">${i.title}</h4><p class="text-xs text-gray-500 uppercase">${i.loc}</p></div></div></div>`; }); c.innerHTML=html; }
        function runTerminalIntro(){ const t=document.getElementById('terminal-output'); setTimeout(()=>document.getElementById('enter-btn').classList.remove('opacity-0'),3000); ["> SYSTEM_INIT...", "> CONNECTING...", "> READY."].forEach((x,i)=>setTimeout(()=>{t.innerHTML+=`<div class='mb-1'>${x}</div>`;}, i*300)); setTimeout(()=>document.getElementById('intro-title').classList.remove('opacity-0'),1500); }
        function enterSite(){ sessionStorage.setItem('introDone','true'); document.getElementById('intro-screen').style.display='none'; document.getElementById('main-content').classList.remove('hidden'); document.getElementById('main-content').style.opacity='1'; document.querySelectorAll('.reveal').forEach(el=>el.classList.add('active')); }
        function switchView(id){ document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); window.scrollTo(0,0); }
        function toggleSidebar(){ const s=document.getElementById('sidebar'); s.classList.contains('-translate-x-full') ? s.classList.remove('-translate-x-full') : s.classList.add('-translate-x-full'); }
        function openModal(){ document.getElementById('auth-modal').classList.remove('hidden'); document.getElementById('auth-modal').style.display='flex'; }
        function closeModal(){ document.getElementById('auth-modal').style.display='none'; }
        function startCountdown() { const d = new Date("Feb 24, 2026 00:00:00").getTime(); setInterval(()=>{ const now=new Date().getTime(), dist=d-now; document.getElementById("cd-days").innerText=Math.floor(dist/(1000*60*60*24)); document.getElementById("cd-hours").innerText=Math.floor((dist%(1000*60*60*24))/(1000*60*60)); document.getElementById("cd-mins").innerText=Math.floor((dist%(1000*60*60))/(1000*60)); },1000); }
        function userLogin(){ auth.signInWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message)); }
        function userRegister(){ const e=document.getElementById('reg-email').value, p=document.getElementById('reg-pass').value, n=document.getElementById('reg-name').value; auth.createUserWithEmailAndPassword(e,p).then(c=>{ db.ref('users/'+e.replace(/\./g,',')).set({name:n, email:e, paymentStatus:'None', uid:c.user.uid}); alert("Registered!"); }).catch(e=>alert(e.message)); }
        function logout(){ auth.signOut().then(()=>window.location.reload()); }
        function handleAccountClick(){ if(!currentUser){ openModal(); document.getElementById('view-auth').classList.remove('hidden'); document.getElementById('view-profile').classList.add('hidden'); } else { openModal(); document.getElementById('view-auth').classList.add('hidden'); document.getElementById('view-profile').classList.remove('hidden'); document.getElementById('profile-name').innerText=userDataDB.name; document.getElementById('profile-email').innerText=currentUser.email; updateTicketUI(); } }
        function updateTicketUI() { if(!userDataDB) return; document.getElementById('ticket-loading').classList.add('hidden'); if(userDataDB.paymentStatus==="Verified") { document.getElementById('ticket-verified').classList.remove('hidden'); document.getElementById('ticket-qr').src=`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${userDataDB.uid}`; document.getElementById('ticket-info-plan').innerText=userDataDB.order.pass; } else if(userDataDB.paymentStatus==="Pending") document.getElementById('ticket-pending').classList.remove('hidden'); else document.getElementById('ticket-none').classList.remove('hidden'); }
        function updateNav(n){ document.getElementById('nav-user-text').innerText = n.split(' ')[0]; }
    </script>
</body>
</html>
